name: Setup

runs:
  using: composite
  steps:
    - name: Install Node
      uses: actions/setup-node@v4
      with:
        node-version: 24.12
    - name: Cache
      uses: actions/cache@v4
      id: cache
      with:
        path: '**/node_modules'
        key: yarn-v1-${{ hashFiles('**/yarn.lock') }}
    - name: Yarn
      run: yarn --immutable
      shell: bash
      if: steps.cache.outputs.cache-hit != 'true'
    - name: Install Foundry
      uses: foundry-rs/foundry-toolchain@v1
    - name: Restore Forked Network Cache
      # Forge caches node requests when working with forked networks (e.g. when querying contract code, storage,
      # etc.) to save time in future runs. We cache this directory across runs.
      # This cache action is special for a couple reasons, which originate from a) it not occupying much disk size,
      # and b) the cache never being invalid (as past blockchain data is immutable). We therefore:
      #  - save the cache even on action failure (which may be caused due to a timeout), even if this could result in
      #    some wasted space. For this we use the always-upload-cache fork of the basic action.
      #  - use a different key on every single run, causing for the cache to always be saved.
      #  - use a wildcard as a restore key, which will cause all stored keys to match and the most recent one to be
      #    selected.
      id: cache-forked-network-restore
      uses: actions/cache/restore@v4
      with:
        path: '~/.foundry/cache/rpc/**'
        key: forge-network-fork-${{ github.run_number }}-${{ github.run_attempt }}
        restore-keys: |
          forge-network-fork-
